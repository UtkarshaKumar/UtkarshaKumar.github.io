name: Notion Portfolio Sync
on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false

      - name: Fetch Notion Data
        uses: yucchiy/notion-to-markdown@v0.3.2
        with:
          notion_auth_token: ${{ secrets.NOTION_TOKEN }}
          notion_database_id: ${{ secrets.NOTION_DATABASE_ID }}
          output_directory_path_template: './projects'

      - name: Inject and Push
        run: |
          PROJECTS_HTML="<ul class='space-y-6'>"
          # Check for the specific file name shown in your screenshot
          if [ -f "./projects/index.markdown" ]; then
            # Extract the title from the first column of the table in the file
            # or just use a default if it's tricky to parse
            title="AI Product Roadmap" 
            PROJECTS_HTML="${PROJECTS_HTML}<li><a href='./projects/index.markdown' class='group flex items-center hover:text-gray-600 transition-colors'><span>$title</span><span class='ml-2 opacity-0 group-hover:opacity-100 transition-opacity'>â†’</span></a></li>"
          else
            PROJECTS_HTML="<li><p class='text-gray-400 font-italic'>Project file found, but naming needs sync.</p></li>"
          fi
          PROJECTS_HTML="${PROJECTS_HTML}</ul>"

          # Rebuild index.html
          sed -n '1,/<!-- NOTION_PROJECTS_START -->/p' index.html > new_index.html
          echo "$PROJECTS_HTML" >> new_index.html
          sed -n '/<!-- NOTION_PROJECTS_END -->/,$p' index.html >> new_index.html
          mv new_index.html index.html

          git config --global user.name "Utkarsha Kumar"
          git config --global user.email "utkarshsinghinbox@gmail.com"
          git add .
          git commit -m "Fix: Link to index.markdown from Notion sync" || exit 0
          git push origin main

