name: Notion Portfolio Sync
on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch Notion Data
        uses: yucchiy/notion-to-markdown@v0.3.2
        with:
          notion_auth_token: ${{ secrets.NOTION_TOKEN }}
          notion_database_id: ${{ secrets.NOTION_DATABASE_ID }}
          output_directory_path_template: './projects' # Fixed input name

      - name: Inject into HTML
        run: |
          PROJECTS_HTML=""
          # The tool puts files in the ./projects/ directory
          if [ -d "./projects" ]; then
            for file in ./projects/*.md; do
              [ -e "$file" ] || continue
              # Extract the title from the first line or filename
              title=$(head -n 1 "$file" | sed 's/# //')
              # Extract the slug from the filename
              slug=$(basename "$file" .md)
              
              PROJECTS_HTML="${PROJECTS_HTML}<li><a href=\"#\" class=\"group flex items-center hover:text-gray-600 transition-colors\"><span>${title:-$slug}</span><span class=\"ml-2 opacity-0 group-hover:opacity-100 transition-opacity\">â†’</span></a></li>"
            done
          fi
          
          # Replace the placeholder in your index.html
          sed -i "/<!-- NOTION_PROJECTS_START -->/,/<!-- NOTION_PROJECTS_END -->/c\<!-- NOTION_PROJECTS_START -->\n<ul class=\"space-y-6\">\n$PROJECTS_HTML\n</ul>\n<!-- NOTION_PROJECTS_END -->" index.html

      - name: Commit and Push
        run: |
          git config --global user.name "Utkarsha Kumar"
          git config --global user.email "utkarshsinghinbox@gmail.com"
          git add .
          git commit -m "Fix: Switch to supported Notion sync tool" || exit 0
          git push