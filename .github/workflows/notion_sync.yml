name: Notion Portfolio Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Sync Notion projects into index.html
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          python3 << 'PYEOF'
          import os, re, html as html_lib, requests

          token = os.environ['NOTION_TOKEN']
          db_id  = os.environ['NOTION_DATABASE_ID']

          headers = {
              'Authorization': f'Bearer {token}',
              'Notion-Version': '2022-06-28',
              'Content-Type': 'application/json',
          }

          # ── helpers ──────────────────────────────────────────────────────────

          def get_excerpt(page_id, max_chars=140):
              """Fetch first meaningful text block from a Notion page."""
              resp = requests.get(
                  f'https://api.notion.com/v1/blocks/{page_id}/children',
                  headers=headers,
                  params={'page_size': 15},
              )
              blocks = resp.json().get('results', [])

              TEXT_TYPES = {
                  'paragraph', 'heading_1', 'heading_2', 'heading_3',
                  'bulleted_list_item', 'numbered_list_item', 'quote', 'callout',
              }
              for block in blocks:
                  btype = block.get('type', '')
                  if btype in TEXT_TYPES:
                      rich = block.get(btype, {}).get('rich_text', [])
                      text = ''.join(r.get('plain_text', '') for r in rich).strip()
                      if text:
                          if len(text) > max_chars:
                              # break at last space so we don't cut mid-word
                              text = text[:max_chars].rsplit(' ', 1)[0] + '…'
                          return text
              return ''

          # ── query database ───────────────────────────────────────────────────

          resp = requests.post(
              f'https://api.notion.com/v1/databases/{db_id}/query',
              headers=headers,
              json={
                  'filter': {
                      'property': 'RequestPublishing',
                      'checkbox': {'equals': True},
                  },
                  'sorts': [{'property': 'PublishedAt', 'direction': 'descending'}],
              },
          )
          data = resp.json()

          if 'results' not in data:
              print('ERROR: Notion API returned:', data)
              exit(1)

          # ── build HTML cards ─────────────────────────────────────────────────

          items_html = []
          for page in data['results']:
              props = page['properties']

              # Title
              title_prop = props.get('Title', props.get('Name', {}))
              title_arr  = title_prop.get('title', [])
              title      = title_arr[0]['plain_text'] if title_arr else 'Untitled'

              # Notion page URL
              notion_url = page.get('url', '#')

              # Date
              date_obj  = props.get('PublishedAt', {}).get('date') or {}
              date_str  = date_obj.get('start', '')
              date_disp = date_str[:7] if date_str else ''

              # Excerpt from first content block
              excerpt = get_excerpt(page['id'])

              # Escape for HTML safety
              safe_title   = html_lib.escape(title)
              safe_excerpt = html_lib.escape(excerpt)
              safe_date    = html_lib.escape(date_disp)

              excerpt_html = (
                  f'<span class="notion-card-excerpt">{safe_excerpt}</span>'
                  if safe_excerpt else ''
              )

              items_html.append(
                  f'<li>'
                  f'<a href="{notion_url}" target="_blank" rel="noopener">'
                  f'<div class="notion-card-body">'
                  f'<span class="notion-card-title">{safe_title}</span>'
                  f'{excerpt_html}'
                  f'</div>'
                  f'<span>{safe_date} &#8599;</span>'
                  f'</a>'
                  f'</li>'
              )

          if items_html:
              block = '<ul>\n' + '\n'.join(items_html) + '\n</ul>'
          else:
              block = '<p style="color:#94a3b8;font-size:0.9rem;padding:1rem 0;">No case studies published yet.</p>'

          # ── inject into index.html ───────────────────────────────────────────

          with open('index.html', 'r') as f:
              page_html = f.read()

          new_html = re.sub(
              r'<!-- NOTION_PROJECTS_START -->.*?<!-- NOTION_PROJECTS_END -->',
              f'<!-- NOTION_PROJECTS_START -->\n{block}\n<!-- NOTION_PROJECTS_END -->',
              page_html,
              flags=re.DOTALL,
          )

          with open('index.html', 'w') as f:
              f.write(new_html)

          print(f'Synced {len(items_html)} project(s)')
          PYEOF

      - name: Commit and push
        run: |
          git config --global user.name "Utkarsh Kumar"
          git config --global user.email "utkarshsinghinbox@gmail.com"
          git add index.html
          git commit -m "Automated Sync: Update projects from Notion" || exit 0
          git push origin main
